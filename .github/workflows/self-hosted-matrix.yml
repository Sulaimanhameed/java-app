name: Build and Push to ECR

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2
  ECR_REPOSITORY: java-app

jobs:
  build-and-push:
    runs-on: arc-runner-set
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: temurin
        cache: maven

    - name: Install Maven
      run: |
        sudo apt-get update
        sudo apt-get install -y maven
        mvn -v   # sanity check

    - name: Build with Maven
      working-directory: ${{ github.workspace }}
      run: mvn clean package -DskipTests -B    

    - name: Build, tag, and push Docker image to Amazon ECR
      env:
        REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        REPOSITORY: ${{ env.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "Building Docker image..."
        docker build -t $REGISTRY/$REPOSITORY:latest .
        docker tag $REGISTRY/$REPOSITORY:latest $REGISTRY/$REPOSITORY:$IMAGE_TAG
        
        echo "Pushing Docker image..."
        docker push $REGISTRY/$REPOSITORY:latest
        docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG

    - name: Image info
      run: |
        echo "âœ… Image pushed successfully!"
        echo "Repository: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}"
        echo "Tags: latest, ${{ github.sha }}"
